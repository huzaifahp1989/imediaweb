service cloud.firestore {
  match /databases/{database}/documents {
    function isAdmin() {
      return request.auth != null &&
             request.auth.token.email.matches(".*@imediackids\\.com");
    }

    // Users profiles: allow each authenticated user to create/update/read their own
    match /users/{uid} {
      // Only the authenticated owner can create or set their profile document
      allow create, set: if request.auth != null && request.auth.uid == uid;
      // Owner can read their own profile; admins can read all for management
      allow read: if request.auth != null && (request.auth.uid == uid || isAdmin());
      // Owner can update their own profile
      allow update: if request.auth != null && request.auth.uid == uid;
      // Only admin can delete user profiles
      allow delete: if isAdmin();
    }

    match /messages/{docId} {
      // Allow anyone to submit a message
      allow create: if true;

      // Only admin can read/update/delete
      allow read, update, delete: if isAdmin();
    }
  }
}
